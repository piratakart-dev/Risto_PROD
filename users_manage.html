{% extends 'dashboard_base.html' %}
{% set title = 'Gestione utenti' %}
{% block content %}
  <div class="page-header">
    <div>
      <h1>Gestione Utenti</h1>
      <p>Controlla e aggiorna gli account del gestionale</p>
    </div>
    <button class="btn-primary" id="new-user">+ Nuovo utente</button>
  </div>

  <div class="grid-two">
    <div class="panel">
      <h3 style="margin-top:0;" id="form-title">Crea o aggiorna utente</h3>
      <form id="user-form" class="stack" novalidate>
        <input type="hidden" id="user-id" />
        <div class="row">
          <div>
            <label for="first_name">Nome*</label>
            <input id="first_name" required />
          </div>
          <div>
            <label for="last_name">Cognome*</label>
            <input id="last_name" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="personal_email">E-mail personale*</label>
            <input id="personal_email" type="email" required />
          </div>
          <div>
            <label for="birth_date">Data di nascita*</label>
            <input id="birth_date" type="date" required />
          </div>
          <div>
            <label for="avs_number">AVS*</label>
            <input id="avs_number" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="canton">Cantone*</label>
            <input id="canton" required />
          </div>
          <div>
            <label for="address">Indirizzo*</label>
            <input id="address" required />
          </div>
          <div>
            <label for="postal_code">CAP*</label>
            <input id="postal_code" required />
          </div>
          <div>
            <label for="city">Città*</label>
            <input id="city" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="role">Ruolo*</label>
            <select id="role" required>
              <option value="manager">Manager</option>
              <option value="user">User</option>
            </select>
          </div>
          <div>
            <label for="password">Password*</label>
            <input id="password" type="password" placeholder="Min 6 caratteri" />
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary" id="submit-btn">Salva</button>
          <button type="button" class="btn-secondary" id="reset-form">Pulisci</button>
        </div>
        <div id="form-status" class="status-box" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <div class="panel">
    <div class="page-header" style="padding:0 0 8px 0;">
      <div>
        <h3 style="margin:0;">Lista utenti</h3>
        <p id="user-count" style="margin:2px 0 0;">0 utenti</p>
      </div>
    </div>
    <div style="overflow:auto;">
      <table id="users-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Ruolo</th>
            <th>Stato</th>
            <th>Azione</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
{% endblock %}
{% block extra_scripts %}
<script>
  const form = document.getElementById('user-form');
  const statusBox = document.getElementById('form-status');
  const tableBody = document.querySelector('#users-table tbody');
  const userCount = document.getElementById('user-count');
  const resetFormBtn = document.getElementById('reset-form');
  const passwordField = document.getElementById('password');
  const formTitle = document.getElementById('form-title');
  const submitBtn = document.getElementById('submit-btn');
  const newUserBtn = document.getElementById('new-user');

  function renderStatus(message, type = 'error') {
    statusBox.textContent = message;
    statusBox.style.color = type === 'error' ? '#b71c1c' : '#047a58';
  }

  function clearForm() {
    form.reset();
    document.getElementById('user-id').value = '';
    formTitle.textContent = 'Crea o aggiorna utente';
    submitBtn.textContent = 'Salva';
    passwordField.placeholder = 'Min 6 caratteri';
  }

  resetFormBtn.addEventListener('click', () => {
    clearForm();
    renderStatus('');
  });
  newUserBtn.addEventListener('click', () => {
    clearForm();
    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  function populateForm(user) {
    document.getElementById('user-id').value = user.id;
    document.getElementById('first_name').value = user.first_name || '';
    document.getElementById('last_name').value = user.last_name || '';
    document.getElementById('personal_email').value = user.personal_email || '';
    document.getElementById('birth_date').value = user.birth_date || '';
    document.getElementById('avs_number').value = user.avs_number || '';
    document.getElementById('address').value = user.address || '';
    document.getElementById('postal_code').value = user.postal_code || '';
    document.getElementById('city').value = user.city || '';
    document.getElementById('canton').value = user.canton || '';
    document.getElementById('role').value = user.role || 'user';
    passwordField.placeholder = 'Lascia vuoto per non cambiare';
    formTitle.textContent = 'Aggiorna utente';
    submitBtn.textContent = 'Aggiorna';
  }

  function renderRow(user) {
    const tr = document.createElement('tr');
    const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim();
    const statusClass = user.status === 'inactive' ? 'inactive' : user.status === 'blocked' ? 'blocked' : 'active';
    tr.innerHTML = `
      <td>${fullName || '-'}<div style="color:#5c6c80; font-size:12px;">${user.address || ''}</div></td>
      <td>${user.personal_email || ''}</td>
      <td><span class="badge ${user.role === 'manager' ? 'manager' : 'user'}">${user.role}</span></td>
      <td><span class="status-dot status ${statusClass}"></span></td>
      <td class="table-actions">
        <button type="button" class="ghost-btn" data-action="edit">Modifica</button>
        <button type="button" class="ghost-btn" data-action="reset">Reset</button>
        <button type="button" class="ghost-btn danger" data-action="delete">Elimina</button>
      </td>`;
    tr.dataset.id = user.id;
    return tr;
  }

  async function fetchUsers() {
    try {
      const response = await fetch('/users', { credentials: 'include' });
      const data = await response.json();
      tableBody.innerHTML = '';
      (data || []).forEach((user) => tableBody.appendChild(renderRow(user)));
      userCount.textContent = `${(data || []).length} utenti`;
    } catch (error) {
      renderStatus('Errore nel caricamento utenti');
    }
  }

  async function handleSubmit(event) {
    event.preventDefault();
    renderStatus('');
    const payload = {
      first_name: document.getElementById('first_name').value.trim(),
      last_name: document.getElementById('last_name').value.trim(),
      birth_date: document.getElementById('birth_date').value,
      avs_number: document.getElementById('avs_number').value.trim(),
      personal_email: document.getElementById('personal_email').value.trim(),
      address: document.getElementById('address').value.trim(),
      postal_code: document.getElementById('postal_code').value.trim(),
      city: document.getElementById('city').value.trim(),
      canton: document.getElementById('canton').value.trim(),
      role: document.getElementById('role').value,
    };

    const userId = document.getElementById('user-id').value;
    const password = passwordField.value.trim();
    if (password) payload.password = password;
    if (!userId && !password) {
      renderStatus('La password è richiesta quando crei un nuovo utente.');
      return;
    }

    const url = userId ? `/users/${userId}` : '/users';
    const method = userId ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok) {
        renderStatus(data.error || 'Errore nel salvataggio');
        return;
      }
      renderStatus(userId ? 'Utente aggiornato' : 'Utente creato', 'success');
      clearForm();
      fetchUsers();
    } catch (error) {
      renderStatus('Errore di rete');
    }
  }

  async function handleReset(userId) {
    const newPassword = prompt('Inserisci la nuova password per questo utente');
    if (!newPassword) return;
    try {
      const response = await fetch(`/users/${userId}/reset_password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ password: newPassword }),
      });
      if (!response.ok) throw new Error();
      renderStatus('Password aggiornata', 'success');
    } catch (_) {
      renderStatus('Impossibile aggiornare la password');
    }
  }

  async function handleDelete(userId) {
    const confirmDelete = confirm('Vuoi eliminare questo utente?');
    if (!confirmDelete) return;
    try {
      const response = await fetch(`/users/${userId}`, { method: 'DELETE', credentials: 'include' });
      if (!response.ok) throw new Error();
      renderStatus('Utente eliminato', 'success');
      fetchUsers();
    } catch (_) {
      renderStatus('Impossibile eliminare utente');
    }
  }

  tableBody.addEventListener('click', async (event) => {
    const button = event.target.closest('button');
    if (!button) return;
    const row = button.closest('tr');
    const userId = row?.dataset.id;
    if (!userId) return;

    const action = button.dataset.action;
    if (action === 'edit') {
      try {
        const response = await fetch(`/users/${userId}`, { credentials: 'include' });
        const data = await response.json();
        if (!response.ok) throw new Error();
        populateForm(data);
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (error) {
        renderStatus('Errore nel recupero utente');
      }
    }
    if (action === 'reset') {
      handleReset(userId);
    }
    if (action === 'delete') {
      handleDelete(userId);
    }
  });

  form.addEventListener('submit', handleSubmit);
  fetchUsers();
</script>
{% endblock %}